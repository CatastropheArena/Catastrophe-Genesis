# Catastrophe 智能合约

Catastrophe 是一款基于 Sui 区块链的卡牌游戏，结合了 GameFi 和 NFT 的特性，允许玩家收集、合成、升级、质押和租赁卡牌，并参与游戏对战以赢取奖励。

## 合约架构

该项目包含六个主要模块，各自负责特定功能区域：

### 1. Card 模块 (`card.move`)

管理游戏卡牌 NFT 的生命周期，包括创建、升级和销毁卡牌。

- **主要功能**：
  - 创建卡牌：根据稀有度创建卡牌对象
  - 升级卡牌：提升卡牌等级
  - 销毁卡牌：销毁卡牌并返回对应的碎片
  - 转移卡牌：更改卡牌所有权

### 2. Fragment 模块 (`fragment.move`)

管理游戏内碎片代币，作为游戏内主要的功能性货币。

- **主要功能**：
  - 铸造碎片：创建新的碎片代币
  - 销毁碎片：销毁碎片代币
  - 合并和分割碎片：管理碎片代币的数量
  - 转移碎片：在地址间转移碎片

### 3. Passport 模块 (`passport.move`)

管理用户身份和资格，每个地址只能拥有一个护照对象。

- **主要功能**：
  - 创建护照：为新用户创建护照
  - 领取每日奖励：通过护照领取每日游戏奖励
  - 管理租赁卡牌：记录用户租赁的卡牌

### 4. Rental 模块 (`rental.move`)

管理卡牌租赁系统，允许玩家出租和租用卡牌。

- **主要功能**：
  - 创建租赁选项：设置租期、使用次数和租金
  - 租用卡牌：支付租金并获得卡牌使用权
  - 使用租赁卡牌：记录卡牌使用情况
  - 结束租赁：到期或用完后结束租赁

### 5. Staking 模块 (`staking.move`)

管理卡牌质押系统，允许玩家质押卡牌获取被动收益。

- **主要功能**：
  - 创建质押池：为不同卡牌类型创建质押池
  - 质押卡牌：将卡牌存入质押池
  - 解除质押：从质押池取回卡牌
  - 计算和领取奖励：计算和发放质押奖励

### 6. Treasury 模块 (`treasury.move`)

管理游戏资金和奖励系统。

- **主要功能**：
  - 存入资金：向资金库存入资金
  - 发放初始奖励：为新用户发放初始资产
  - 发放每日奖励：为用户发放每日奖励
  - 管理员提取资金：管理游戏资金

## 核心流程

### 1. 用户注册流程

1. 用户首次访问游戏
2. 系统创建护照对象绑定到用户地址
3. 游戏发放初始资产（250 碎片和少量游戏币）
4. 用户通过合成或抽卡获得初始卡牌

### 2. 卡牌获取流程

用户可以通过以下方式获取卡牌：
- 使用游戏币抽取卡牌
- 使用碎片合成卡牌
- 租赁其他玩家的卡牌
- 在游戏对战中获胜获得卡牌

### 3. 卡牌经济体系

- **质押系统**：玩家可以将卡牌质押到不同的池子中，获取被动收益
- **租赁系统**：玩家可以出租自己的卡牌，获取租金收入
- **碎片系统**：玩家可以销毁不需要的卡牌，获得碎片用于合成新卡牌

## 使用方法

### 编译合约

```bash
sui move build
```

### 发布合约

```bash
sui client publish --gas-budget 30000000
```

### 初始化游戏

1. 创建 Fragment 代币
2. 创建游戏资金库
3. 创建基本质押池

## 开发注意事项

1. 合约依赖 Sui Framework 提供的功能，请确保使用兼容的版本
2. 事件系统广泛用于记录关键操作，便于前端追踪状态变化
3. 所有资金相关操作都有严格的访问控制和验证
4. 使用共享对象模式实现多用户交互的功能

## 安全考虑

1. 所有关键操作都有所有权验证
2. 资金和状态更新在外部调用前完成，避免重入攻击
3. 参数验证确保所有操作在有效范围内
4. 错误代码清晰指示错误原因

## 前端集成

前端通过以下方式与合约交互：
1. 调用合约函数进行游戏操作
2. 监听事件获取状态更新
3. 查询对象获取当前游戏状态

详细的前端集成说明请参见 `horizon` 文件夹中的实现。 